<p>###Go的调度器</p>

<p>原文地址: <a href="http://http://morsmachine.dk/go-scheduler">http://http://morsmachine.dk/go-scheduler</a></p>

<p>简介：</p>

<blockquote>
  <p>Go 1.1版本中值得注意的新特性之一就是新的调度器，由Dmitry Vyukov贡献。新的调度器将Go程序的并行性能提升到了一个全新的高度，对此我想我该写点什么了。</p>
</blockquote>

<p>在这篇博客中说到的大部分内容都在<a href="https://docs.google.com/document/d/1TTj4T2JO42uD5ID9e89oa0sLKhJYD0Y_kqxDv3I3XMw/edit">original design doc</a>提到了，不得不说这是一篇挺综合性与技术性兼具的文档。</p>

<p>你需要对新的调度器有所了解的都在那篇设计文档里讲解了，但是这篇里面有图有真相，就可理解性来说这篇更被推荐。</p>

<hr />

<p>Golang的runtime到底需要一个什么样的调度器呢?</p>

<p>我们来仔细剖析新的调度器前，我们得了解下调度器存在的必要性 ---- 在操作系统能够为你提供线程调度的情况下，我们为什么还要自己去实现一个用户空间下的调度器?</p>

<p>POSIX标准的线程API是对既有的Unix进程模型的相当逻辑化的扩展，由此对线程的许多操作也继承自进程操作。线程有着他们自身的信号屏蔽字(signal mask)，可以进行调度，可以放到cgroups中，或者查询相关的资源。这些控制以及部分资源对Golang中的goroutine而言，不是必要的，而且当系统中的线程数超过10万时，不必要的负担就非常明显了。</p>

<p>另外一个问题在于，操作系统无法根据Golang所需要的底层模型选择与之相匹配的调度策略（可定制性..）.例如：</p>

<blockquote>
  <p>Golang的垃圾收集器规定：当进行垃圾收集的时候，所有的相关线程应当停止，同时内存数据必须保证一致性。这牵涉到等待一个正在执行的线程达到我们所需要以及可确定的内存一致状态。</p>
  
  <p>而对于一般情况下的操作系统级别的线程调度，由于执行的先后顺序不能确定，使得等待并确认所有的线程达到内存一致性状态是一件麻烦的事情。要是有了我们自己的调度器，那么这些就不会是问题，可达的内存一致性的点可以预先获得，并在最适合的时机停下来，完成垃圾收集工作，而此时最多就是等待花在当前在CPU上运行的线程上。</p>
</blockquote>

<p>####角色的模具</p>

<p>一般有三种常见的线程模型。</p>

<ul>
<li><p>N对1模型，这种模型一般是多个用户空间的线程映射到一个OS线程，这种线程模型的好处在于，可以进行快速的上下文切换，以及自定义的切换策略，但是不足之处也很明显，不能有效利用操作系统多核的优势。</p></li>
<li><p>1对1模型，这种模型下，一个用户空间的线程对应的就是一个OS的线程，这种线程模型能够有效利用OS多核优势，但是线程切换就要附加一定的开销，因为调度是由操作系统完成的，trap涉及到系统调用，核心态的来回切换比较耗时。</p></li>
<li><p>第三种模型，也是Golang所追求的之前二者的一个折衷 ---- M对N。若干个Goroutine被挂靠在若干个OS线程上，如果做法得当，你得到高上下文切换效率的同时，也能利用操作系统的多核优势。唯一不足的是应对可能不同额Goroutine间的协作情境，调度器的实现就变得复杂了。</p></li>
</ul>

<p>为了实现M对N模型，Golang的调度器采用了三种实体模型：</p>

<p><img src="http://morsmachine.dk/our-cast.jpg" alt="MPG entities for Golang Scheduler" /></p>

<ul>
<li><p>三角形代表了OS线程，这是由OS直接进行调度执行的线程，与POSIX标准线程差不多。在runtime代码中，M指的是Machine.</p></li>
<li><p>圆圈代表的是一个Goroutine。其数据结构是一个栈，指令指针（指向预执行的地址）以及对Goroutine调度所必须的一些信息，例如阻塞的通道（Channel）。</p></li>
<li><p>矩形的P代表调度的当前上下文。你可以将其视为本地版本的Golang执行调度器，工作在单线程上。这是实现M:N线程模型很重要的一环。P全称是Processor。后面会讲的更深入一些。</p></li>
</ul>

<p><img src="http://morsmachine.dk/in-motion.jpg" alt="example1" /></p>
